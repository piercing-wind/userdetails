name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1  # Change to your preferred region
  PROJECT_ID: ${{ github.event.repository.name }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required to checkout code
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'  # Matching buildspec.yml runtime version
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Package Lambda functions and CloudFormation templates
      run: |
        # Set environment variables
        export PARTITION="aws"
        export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        export S3_BUCKET="${PROJECT_ID}-${AWS_REGION}-${ACCOUNT_ID}-pipeline-artifacts"
        
        # Save to GITHUB_ENV for use in subsequent steps
        echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV
        echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
        
        echo "S3 bucket is $S3_BUCKET"
        echo "AWS_DEFAULT_REGION is $AWS_REGION"
        echo "AWS_REGION is $AWS_REGION"
        echo "ACCOUNT_ID is $ACCOUNT_ID"

        echo "Installing Lambda dependencies..."
        cd stacks/lambdas_nodejs/getCounty
        npm install --production
        cd -

        echo "Entering POST_BUILD phase"
        pwd
        ls -ltr
        
        # Package CloudFormation template - this will:
        # 1. Zip the Lambda code (including node_modules)
        # 2. Upload the zip to S3
        # 3. Replace Code path with S3 URI in template-export.yml
        echo "Packaging CloudFormation template..."
        aws cloudformation package \
          --template-file stacks/userdetails-lambdas-simple.yaml \
          --s3-bucket $S3_BUCKET \
          --output-template-file template-export.yml
        
        echo "Package command completed"
        ls -la template-export.yml

    - name: Upload artifacts to S3
      run: |
        # Use variables from previous step (saved to GITHUB_ENV)
        echo "Using S3 bucket: $S3_BUCKET"
        echo "Using Account ID: $ACCOUNT_ID"
        
        # Create a zip file with template and existing params directory
        # template-export.yml was generated in previous step
        # params/ directory already exists in the repo
        zip -r "${PROJECT_ID}-build-artifacts.zip" template-export.yml params/
        
        # Upload to S3
        aws s3 cp "${PROJECT_ID}-build-artifacts.zip" "s3://${S3_BUCKET}/${PROJECT_ID}-build-artifacts.zip"
        
        echo "Build artifacts uploaded to s3://${S3_BUCKET}/${PROJECT_ID}-build-artifacts.zip"

    - name: Trigger CodePipeline
      run: |
        # Start the pipeline execution
        PIPELINE_NAME="${PROJECT_ID}-Pipeline"
        aws codepipeline start-pipeline-execution --name "$PIPELINE_NAME"
        
        echo "Pipeline $PIPELINE_NAME execution started"