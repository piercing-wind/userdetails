name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1  # Change to your preferred region
  PROJECT_ID: ${{ github.event.repository.name }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required to checkout code
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'  # Matching buildspec.yml runtime version
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install dependencies
      run: |
        # Install dependencies for Lambda functions
        find . -name "package.json" -not -path "./node_modules/*" -execdir npm install \;

    - name: Package Lambda functions and CloudFormation templates
      run: |
        # Set environment variables FIRST (matching buildspec.yml environment)
        export PARTITION="aws"
        export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        export S3_BUCKET="${PROJECT_ID}-${AWS_REGION}-${ACCOUNT_ID}-pipeline-artifacts"
        
        echo "S3 bucket is $S3_BUCKET"
        echo "AWS_DEFAULT_REGION is $AWS_REGION"
        echo "AWS_REGION is $AWS_REGION"
        echo "ACCOUNT_ID is $ACCOUNT_ID"
        
        # Install Lambda dependencies (matching buildspec.yml)
        cd stacks/lambdas_nodejs/getCounty
        npm install
        cd -
        
        echo "Entering POST_BUILD phase"
        pwd
        ls -ltr
        
        # Package CloudFormation templates (matching buildspec.yml post_build)
        aws cloudformation package --template stacks/userdetails-lambdas.yaml --s3-bucket $S3_BUCKET --output-template-file template-export.yml
        aws cloudformation package --template stacks/userdetails-lambdas-observability.yaml --s3-bucket $S3_BUCKET --output-template-file userdetails-lambdas-observability-export.yml
        
        # Process parameter files (matching buildspec.yml sed commands)
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/dev/userdetails-parameters-lambdas.json
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/qa/userdetails-parameters-lambdas.json
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/prod/userdetails-parameters-lambdas.json
        
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/dev/userdetails-parameters-lambdas-observability-lambda-1.json
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/qa/userdetails-parameters-lambdas-observability-lambda-2.json
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/prod/userdetails-parameters-lambdas-observability-lambda-1.json
        sed -i.bak "s/\$PARTITION\$/${PARTITION}/g;s/\$AWS_REGION\$/${AWS_REGION}/g;s/\$ACCOUNT_ID\$/${ACCOUNT_ID}/g;s/\$PROJECT_ID\$/${PROJECT_ID}/g" params/prod/userdetails-parameters-lambdas-observability-lambda-2.json
        
        ls -la

    - name: Upload artifacts to S3
      run: |
        # Get the S3 bucket name (matching buildspec.yml artifacts)
        export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        export S3_BUCKET="${PROJECT_ID}-${AWS_REGION}-${ACCOUNT_ID}-pipeline-artifacts"
        
        # Create artifacts directory structure matching buildspec.yml
        mkdir -p artifacts
        
        # Copy artifacts matching buildspec.yml artifacts section
        cp template-export.yml artifacts/
        cp params/dev/userdetails-parameters-lambdas.json artifacts/
        cp params/qa/userdetails-parameters-lambdas.json artifacts/
        cp params/prod/userdetails-parameters-lambdas.json artifacts/
        cp userdetails-lambdas-observability-export.yml artifacts/
        
        # Create a zip file with all build artifacts
        cd artifacts
        zip -r "../${PROJECT_ID}-build-artifacts.zip" .
        cd ..
        
        # Upload to S3
        aws s3 cp "${PROJECT_ID}-build-artifacts.zip" "s3://${S3_BUCKET}/${PROJECT_ID}-build-artifacts.zip"
        
        echo "Build artifacts uploaded to s3://${S3_BUCKET}/${PROJECT_ID}-build-artifacts.zip"

    - name: Trigger CodePipeline
      run: |
        # Start the pipeline execution
        PIPELINE_NAME="${PROJECT_ID}-Pipeline"
        aws codepipeline start-pipeline-execution --name "$PIPELINE_NAME"
        
        echo "Pipeline $PIPELINE_NAME execution started"