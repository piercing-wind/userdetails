AWSTemplateFormatVersion: 2010-09-09
Description: My custom toolchain

Parameters:
  # You can provide these parameters in your CreateProject API call.
  ProjectId:
    Description: Name of your applcation.
    Type: String
  Environment:
    Description: Env
    Type: String

Resources:

  # If your pipeline will create resources through AWS CloudFormation as well as deploy your source code, then specify a role for AWS CloudFormation to use. These permissions dictate which runtime resources
  # AWS CloudFormation can create and modify on your behalf
  CloudFormationTrustRole:
    Type: AWS::IAM::Role
    Description: Creating service role in IAM for AWS CloudFormation
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
      Path: /
      RoleName: !Sub "${ProjectId}-CloudFormation-Role"
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - lambda:*
                  - cloudformation:*
                  - iam:*
                  - apigateway:*
                  - logs:*
                  - ec2:CreateSecurityGroup
                  - ec2:DeleteSecurityGroup
                  - ec2:DescribeSecurityGroups
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupEgress
                  - ec2:CreateTags
                  - ec2:CreateVpcEndpoint
                  - ec2:DeleteVpcEndpoint
                  - ec2:DescribeVpcEndpoints
                  - ec2:ModifyVpcEndpoint
                Effect: Allow
                Resource: "*"
          PolicyName: CloudFormationRolePolicy

  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Description: Creating Amazon S3 bucket for AWS CodePipeline artifacts
    Properties:
      BucketName: !Sub "${ProjectId}-${AWS::Region}-${AWS::AccountId}-pipeline-artifacts"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectId}-S3Bucket"
      VersioningConfiguration:
        Status: Enabled

  CodePipelineTrustRole:
    Type: AWS::IAM::Role
    Description: Creating service role in IAM for AWS CodePipeline
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Sid: 1
            Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
      Path: /
      RoleName: !Sub "${ProjectId}-CodePipeline-Role"
      Policies:
        - PolicyName: CodePipelineRolePolicy
          PolicyDocument:
            Statement:
              - Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketVersioning
                  - s3:PutObject
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:DescribeStacks
                  - cloudformation:GetTemplate
                Effect: Allow
                Resource: "*"
              - Action:
                  - iam:PassRole
                Effect: Allow
                Resource:
                  - !GetAtt CloudFormationTrustRole.Arn

  # This policy is applied to the amazon S3 bucket that AWS CodePipeline will use as your artifact store.
  # GitHub Actions will need access to S3 bucket for uploading build artifacts
  S3ArtifactBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn:
      - S3Bucket
      - CodePipelineTrustRole
      - CloudFormationTrustRole
    Description: Setting Amazon S3 bucket policy for AWS CodePipeline access
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Id: SSEAndSSLPolicy
        Version: 2012-10-17
        Statement:
          - Sid: WhitelistedGet
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:GetBucketVersioning
            Condition:
              Bool:
                aws:SecureTransport: false
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt CodePipelineTrustRole.Arn
                - !GetAtt CloudFormationTrustRole.Arn
            Resource:
              - !Sub "arn:aws:s3:::${S3Bucket}"
              - !Sub "arn:aws:s3:::${S3Bucket}/*"
          - Sid: WhitelistedPut
            Action:
              - s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt CodePipelineTrustRole.Arn
            Resource:
              - !Sub "arn:aws:s3:::${S3Bucket}"
              - !Sub "arn:aws:s3:::${S3Bucket}/*"

  # This pipeline contains three Stages: Source, Build, and Deploy.
  ProjectPipeline:
    Type: AWS::CodePipeline::Pipeline
    DependsOn:
      - CodePipelineTrustRole
      - S3Bucket
      - CloudFormationTrustRole
    Description: Creating a deployment pipeline for your project in AWS CodePipeline
    Properties:
      ArtifactStore:
        Location: !Ref S3Bucket
        Type: S3
      Name: !Sub "${ProjectId}-Pipeline"
      RoleArn: !GetAtt CodePipelineTrustRole.Arn
      Stages:
          - Actions:
              - ActionTypeId:
                  Category: Source
                  Owner: AWS
                  Provider: S3
                  Version: 1
                Configuration:
                  S3Bucket: !Ref S3Bucket
                  S3ObjectKey: !Sub "${ProjectId}-build-artifacts.zip"
                  PollForSourceChanges: false
                InputArtifacts: []
                Name: BuildArtifacts
                OutputArtifacts:
                  - Name: !Sub "${ProjectId}-BuildArtifact"
                RunOrder: 1
            Name: Source
          - Actions:
              - ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_REPLACE
                  Capabilities: CAPABILITY_NAMED_IAM
                  ChangeSetName: pipeline-changeset
                  RoleArn: !GetAtt "CloudFormationTrustRole.Arn"
                  StackName: !Sub "${ProjectId}-lambda"
                  # These are the parameters that will be set in your AWS CloudFormation stack
                  ParameterOverrides: !Sub '{"ProjectId":"${ProjectId}","Environment":"${Environment}"}'
                  TemplateConfiguration: !Sub "${ProjectId}-BuildArtifact::params/${Environment}/userdetails-parameters-lambdas.json"
                  # GitHub Actions will build and upload the CloudFormation template
                  TemplatePath: !Sub "${ProjectId}-BuildArtifact::template-export.yml"
                Name: GenerateChangeSet
                InputArtifacts:
                  - Name: !Sub "${ProjectId}-BuildArtifact"
                OutputArtifacts: []
                RunOrder: 1
              - ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_EXECUTE
                  ChangeSetName: pipeline-changeset
                  StackName: !Sub "${ProjectId}-lambda"
                InputArtifacts: []
                Name: ExecuteChangeset
                OutputArtifacts: []
                RunOrder: 2
            Name: Deploy
    
  # GitHub uses webhooks to trigger CodePipeline automatically
  # No CloudWatch Events rule needed for GitHub source
