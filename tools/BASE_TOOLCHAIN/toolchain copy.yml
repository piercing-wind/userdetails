AWSTemplateFormatVersion: 2010-09-09
Description: My custom toolchain

Parameters:
  # You can provide these parameters in your CreateProject API call.
  ProjectId:
    Description: Name of your applcation.
    Type: String
  Environment:
    Description: Env
    Type: String
  GithubOrg:
    Description: GitHub site
    Type: String
  GithubRepo:
    Description: GitHub repo name
    Type: String
  GithubConnectionUuid:
    Description: GitHub CodeConnections UUID
    Type: String

Resources:
  # Each AWS Codebuild project requires a role for AWS CodeBuild to operate on your code.
  CodeBuildRole:
    Description: Creating service role in IAM for AWS CodeBuild
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
      Path: /
      RoleName: !Sub "${ProjectId}-CodeBuild-Role"
    Type: AWS::IAM::Role

  # This minimal set of permissions lets AWS CodeBuild retrieve your encrypted code artifact from Amazon S3 and store its logs in Amazon cloudWatch Logs
  CodeBuildpolicy:
    Description: Setting IAM policy for AWS CodeBuild role
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - logs:*
              - s3:*
              - lambda:* #--# used for automated testing lambda:invoke
              - secretsmanager:*
              - codeconnections:UseConnection
              - codeconnections:GetConnection
            Effect: Allow
            Resource: "*"
      PolicyName: CodeBuildPolicy
      Roles:
        - !Ref "CodeBuildRole"

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    DependsOn:
      - CodeBuildpolicy
    Properties:
      Artifacts:
        Type: codepipeline
        Packaging: zip
      Description: !Join
        - ""
        - - "CodeBuild Project for "
          - !Ref ProjectId
      ServiceRole: !Ref CodeBuildRole
      Environment:
        Type: LINUX_CONTAINER
        Image: "aws/codebuild/amazonlinux2-x86_64-standard:5.0"
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
          - Name: S3_BUCKET
            Value: !Ref S3Bucket
          - Name: WEBSITE_S3_PREFIX
            Value: NoVal
          - Name: WEBSITE_S3_BUCKET
            Value: NoVal
          - Name: PROJECT_ID
            Value: !Ref ProjectId
          - Name: ACCOUNT_ID
            Value: !Ref "AWS::AccountId"
          - Name: PARTITION
            Value: !Ref "AWS::Partition"
      Source:
        Type: codepipeline
      Name: !Ref ProjectId

  # If your pipeline will create resources through AWS CloudFormation as well as deploy your source code, then specify a role for AWS CloudFormation to use. These permissions dictate which runtime resources
  # AWS CloudFormation can create and modify on your behalf
  CloudFormationTrustRole:
    Type: AWS::IAM::Role
    Description: Creating service role in IAM for AWS CloudFormation
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
      Path: /
      RoleName: !Sub "${ProjectId}-CloudFormation-Role"
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - s3:*
                  - lambda:*
                  - cloudformation:*
                  - config:*
                  - iam:*
                  - apigateway:*
                  - cloudwatch:*
                  - logs:*
                  - events:*
                Effect: Allow
                Resource: "*"
          PolicyName: CloudFormationRolePolicy

  # This policy is applied to the amazon S3 bucket that AWS CodePipeline will use as your artifact store.
  S3ArtifactBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn:
      - S3Bucket
      - CodePipelineTrustRole
      - CodeBuildRole
      - CloudFormationTrustRole
    Description: Setting Amazon S3 bucket policy for AWS CodePipeline access
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Id: SSEAndSSLPolicy
        Version: 2012-10-17
        Statement:
          - Sid: WhitelistedGet
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:GetBucketVersioning
            Condition:
              Bool:
                aws:SecureTransport: false
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt CodePipelineTrustRole.Arn
                - !GetAtt CodeBuildRole.Arn
                - !GetAtt CloudFormationTrustRole.Arn
            Resource:
              - !Sub "arn:aws:s3:::${S3Bucket}"
              - !Sub "arn:aws:s3:::${S3Bucket}/*"
          - Sid: WhitelistedPut
            Action:
              - s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt CodePipelineTrustRole.Arn
                - !GetAtt CodeBuildRole.Arn
            Resource:
              - !Sub "arn:aws:s3:::${S3Bucket}"
              - !Sub "arn:aws:s3:::${S3Bucket}/*"

  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Description: Creating Amazon S3 bucket for AWS CodePipeline artifacts
    Properties:
      BucketName: !Sub "${ProjectId}-${AWS::Region}-${AWS::AccountId}-pipeline-artifacts"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectId}-S3Bucket"
      VersioningConfiguration:
        Status: Enabled

  CodePipelineTrustRole:
    Type: AWS::IAM::Role
    Description: Creating service role in IAM for AWS CodePipeline
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Sid: 1
            Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
      Path: /
      RoleName: !Sub "${ProjectId}-CodePipeline-Role"
      Policies:
        - PolicyName: CodePipelineRolePolicy
          PolicyDocument:
            Statement:
              - Action:
                  - s3:*
                  - codebuild:*
                  - cloudformation:*
                  - codestar-connections:UseConnection
                  - codecommit:GetRepository
                  - appconfig:StartDeployment
                  - appconfig:GetDeployment
                  - appconfig:StopDeployment
                Effect: Allow
                Resource: "*"
              - Action:
                  - iam:PassRole
                Effect: Allow
                Resource:
                  - !GetAtt CloudFormationTrustRole.Arn


  # This pipeline contains three Stages: Source, Build, and Deploy.
  ProjectPipeline:
    Type: AWS::CodePipeline::Pipeline
    DependsOn:
      - CodePipelineTrustRole
      - S3Bucket
      - CodeBuildProject
      - CloudFormationTrustRole
    Description: Creating a deployment pipeline for your project in AWS CodePipeline
    Properties:
      ArtifactStore:
        Location: !Ref S3Bucket
        Type: S3
      Name: !Sub "${ProjectId}-Pipeline"
      RoleArn: !GetAtt CodePipelineTrustRole.Arn
      Stages:
          - Actions:
              - ActionTypeId:
                  Category: Source
                  Owner: AWS
                  Provider: CodeStarSourceConnection
                  Version: 1
                Configuration:
                  BranchName: main
                  ConnectionArn: !Sub "arn:aws:codeconnections:${AWS::Region}:${AWS::AccountId}:connection/${GithubConnectionUuid}"
                  FullRepositoryId: !Sub "${GithubOrg}/${GithubRepo}"
                  OutputArtifactFormat: CODE_ZIP
                InputArtifacts: []
                Name: ApplicationSource
                OutputArtifacts:
                  - Name: !Sub "${ProjectId}-SourceArtifact"
                RunOrder: 1
            Name: Source
          - Actions:
              - ActionTypeId:
                  Category: Build
                  Owner: AWS
                  Provider: CodeBuild
                  Version: 1
                Configuration:
                  ProjectName: !Ref CodeBuildProject
                InputArtifacts:
                  - Name: !Sub "${ProjectId}-SourceArtifact"
                Name: PackageExport
                OutputArtifacts:
                  - Name: !Sub "${ProjectId}-BuildArtifact"
                RunOrder: 1
            Name: Build
          - Actions:
              - ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_REPLACE
                  Capabilities: CAPABILITY_NAMED_IAM
                  ChangeSetName: pipeline-changeset
                  RoleArn: !GetAtt "CloudFormationTrustRole.Arn"
                  StackName: !Sub "${ProjectId}-lambda"
                  # These are the parameters that will be set in your AWS CloudFormation stack
                  ParameterOverrides: !Sub '{"ProjectId":"${ProjectId}"}'
                  # Our sample AWS Codebuild project uses the following yml file to run a build,
                  # and then AWS CodeBuiild places the file into build artifact.
                  # Modify this line to point to a different yml file you want AWS CodeBuild to use.
                  TemplatePath: !Sub "${ProjectId}-buildArtifact::template-export.yml"
                Name: GenerateChangeSet
                InputArtifacts:
                  - Name: !Sub "${ProjectId}-BuildArtifact"
                OutputArtifacts: []
                RunOrder: 1
              - ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_EXECUTE
                  ChangeSetName: pipeline-changeset
                  StackName: !Sub "${ProjectId}-lambda"
                InputArtifacts: []
                Name: ExecuteChangeset
                OutputArtifacts: []
                RunOrder: 2
            Name: Deploy
    
  # GitHub uses webhooks to trigger CodePipeline automatically
  # No CloudWatch Events rule needed for GitHub source
